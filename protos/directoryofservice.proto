syntax = "proto3";
package directoryofservice;

// Peer represents an online peer in the directory.
message Peer {
  string ip = 1;        // IP address of the peer
  string username = 2;  // Username of the peer
}

// RequestType enumerates the different types of requests that can be pending.
enum RequestType {
  FRIEND_REQUEST = 0;
  IMAGE_REQUEST = 1;
  VIEWS_COUNT_EDIT_REQUEST = 2;
  USERS_PERMISSION_REQUEST = 3;
}

// Request represents a pending request in the directory.
message Request {
  string from_username = 1;     // Username of the requester
  string to_username = 2;       // Username of the recipient
  RequestType request_type = 3; // Type of the request
  // Optional: Image IDs involved in the request.
  // Used for IMAGE_REQUEST, VIEWS_COUNT_EDIT_REQUEST, and USERS_PERMISSION_REQUEST.
  repeated string image_id = 4;
  // Optional: View counts corresponding to each image_id.
  // Must match the size of image_id list. Each index corresponds to the view count for that image.
  // For VIEWS_COUNT_EDIT_REQUEST: contains a single element (the updated view count).
  // For IMAGE_REQUEST: contains view counts for all requested images.
  repeated int32 updated_view_count = 5;
  int64 timestamp = 6; // Unix timestamp (ms or seconds) when the request was created
}

// Request message for registering a peer.
message RegisterPeerRequest {
  string ip = 1;        // IP address of the peer
  string username = 2;  // Username of the peer
}

// Response for peer registration.
message RegisterPeerResponse {
  bool success = 1;     // Whether the peer was successfully registered
  string message = 2;   // Optional message (e.g., error description or confirmation)
}

// Request message for client heartbeat.
message HeartbeatRequest {
  string ip = 1;        // IP address of the client
  string username = 2;  // Username of the client
}

// Response for heartbeat confirmation.
message HeartbeatResponse {
  bool success = 1;     // Whether the heartbeat was successfully recorded
}

// Request message for getting online peers (can be empty or contain filters).
message GetOnlinePeersRequest {
  // Could add optional filters here if needed (e.g., by username pattern)
}

// Response containing the list of online peers.
message GetOnlinePeersResponse {
  repeated Peer peers = 1;
}

// Request message for getting pending requests.
message GetPendingRequestsRequest {
  // Optional: filter by username to get requests for a specific user
  optional string username = 1;
}

// Response containing the list of pending requests.
message GetPendingRequestsResponse {
  repeated Request requests = 1;
}

// Request message for adding a pending request.
message AddPendingRequestRequest {
  Request request = 1;
}

// Response for adding a pending request.
message AddPendingRequestResponse {
  bool success = 1;     // Whether the request was successfully added
  string message = 2;   // Optional message (e.g., error description)
}

// Request message for accepting a friend request.
message AcceptFriendRequestRequest {
  string from_username = 1;  // Username who sent the friend request
  string to_username = 2;    // Username who is accepting (current user)
}

// Response for accepting a friend request.
message AcceptFriendRequestResponse {
  bool success = 1;
  string message = 2;
}

// Request message for getting friends list.
message GetFriendsRequest {
  string username = 1;  // Username to get friends for
}

// Response containing the list of friends.
message GetFriendsResponse {
  repeated string friends = 1;  // List of friend usernames
}

// Request message for checking friendship status.
message CheckFriendshipRequest {
  string user1 = 1;
  string user2 = 2;
}

// Response for friendship status check.
message CheckFriendshipResponse {
  bool are_friends = 1;
}

// ===== IMAGE STORAGE MESSAGES =====

// Message representing shared access for an image
message SharedAccess {
  string username = 1;
  int32 views_allowed = 2;
  int32 views_used = 3;
}

// Message representing stored image metadata
message ImageMetadata {
  string image_id = 1;
  string username = 2;  // Owner username
  string filename = 3;
  uint64 size = 4;
  int64 uploaded_at = 5;  // Unix timestamp in milliseconds
  bool encrypted = 6;
  string image_data = 7;  // base64 encoded
  optional string encrypted_data = 8;  // base64 encoded encrypted version
  optional string thumbnail_base64 = 9;
  repeated SharedAccess shared_with = 10;
}

// Request to save an image to the server
message SaveImageRequest {
  ImageMetadata image = 1;
}

// Response for saving an image
message SaveImageResponse {
  bool success = 1;
  string message = 2;
  string image_id = 3;
}

// Request to get images owned by a user
message GetUserImagesRequest {
  string username = 1;
}

// Response containing user's images
message GetUserImagesResponse {
  repeated ImageMetadata images = 1;
}

// Request to get images shared with a user
message GetSharedImagesRequest {
  string username = 1;
}

// Response containing shared images
message GetSharedImagesResponse {
  repeated ImageMetadata images = 1;
}

// Request to update shared access for an image
message UpdateSharedAccessRequest {
  string image_id = 1;
  string owner_username = 2;
  string shared_username = 3;
  int32 views_allowed = 4;
}

// Response for updating shared access
message UpdateSharedAccessResponse {
  bool success = 1;
  string message = 2;
}

// Request to remove shared access
message RemoveSharedAccessRequest {
  string image_id = 1;
  string owner_username = 2;
  string shared_username = 3;
}

// Response for removing shared access
message RemoveSharedAccessResponse {
  bool success = 1;
  string message = 2;
}

// Request to increment view count
message IncrementViewCountRequest {
  string image_id = 1;
  string owner_username = 2;
  string viewer_username = 3;
}

// Response for incrementing view count
message IncrementViewCountResponse {
  bool success = 1;
  string message = 2;
}

// Request to delete an image
message DeleteImageRequest {
  string image_id = 1;
  string username = 2;
}

// Response for deleting an image
message DeleteImageResponse {
  bool success = 1;
  string message = 2;
}

// Request to get a specific image
message GetImageRequest {
  string image_id = 1;
  string owner_username = 2;
}

// Response containing the image
message GetImageResponse {
  bool success = 1;
  optional ImageMetadata image = 2;
}

// DirectoryOfService provides methods to query the directory for peers and requests.
service DirectoryOfService {
  // Register a peer with the directory service.
  rpc RegisterPeer(RegisterPeerRequest) returns (RegisterPeerResponse);
  
  // Send a heartbeat to indicate the client is still online.
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  
  // Get the list of currently online peers.
  rpc GetOnlinePeers(GetOnlinePeersRequest) returns (GetOnlinePeersResponse);
  
  // Get the list of pending requests from the directory.
  rpc GetPendingRequests(GetPendingRequestsRequest) returns (GetPendingRequestsResponse);
  
  // Add a new pending request to the directory.
  rpc AddPendingRequest(AddPendingRequestRequest) returns (AddPendingRequestResponse);
  
  // Accept a friend request and create a friendship.
  rpc AcceptFriendRequest(AcceptFriendRequestRequest) returns (AcceptFriendRequestResponse);
  
  // Get the list of friends for a user.
  rpc GetFriends(GetFriendsRequest) returns (GetFriendsResponse);
  
  // Check if two users are friends.
  rpc CheckFriendship(CheckFriendshipRequest) returns (CheckFriendshipResponse);
  
  // ===== IMAGE STORAGE METHODS =====
  
  // Save an image to the server
  rpc SaveImage(SaveImageRequest) returns (SaveImageResponse);
  
  // Get all images owned by a user
  rpc GetUserImages(GetUserImagesRequest) returns (GetUserImagesResponse);
  
  // Get all images shared with a user
  rpc GetSharedImages(GetSharedImagesRequest) returns (GetSharedImagesResponse);
  
  // Update shared access for an image
  rpc UpdateSharedAccess(UpdateSharedAccessRequest) returns (UpdateSharedAccessResponse);
  
  // Remove shared access for an image
  rpc RemoveSharedAccess(RemoveSharedAccessRequest) returns (RemoveSharedAccessResponse);
  
  // Increment view count for an image
  rpc IncrementViewCount(IncrementViewCountRequest) returns (IncrementViewCountResponse);
  
  // Delete an image
  rpc DeleteImage(DeleteImageRequest) returns (DeleteImageResponse);
  
  // Get a specific image
  rpc GetImage(GetImageRequest) returns (GetImageResponse);
}